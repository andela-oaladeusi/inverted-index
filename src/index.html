<!DOCTYPE html>

<head>

    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

    <title>Andela Bootcamp- Chart Application</title>
    <link rel="stylesheet" type="text/css" href="css/main.css" />
    <link rel="stylesheet" type="text/css" href="css/jlAqp.css" />
    <script type="text/javascript" src="js/jquery-3.1.1.js"></script>
    <script type="text/javascript" src="js/inverted-index.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">

</head>

<body>

    <section id="page">

        <header>

            <hgroup>
                <a href="index.html">
                    <h1>Andela</h1>
                    <h3 id="IA">Inverted Application</h3>
                </a>
            </hgroup>

        </header>
        <section id="articles">
            <div class="line"></div>

            <article id="article1">
                <div class="articleBody clear">
                    <figure>
                        <div>
                            <div id="uploadDiv" >
                                <h3> Upload Your JSON file</h3>
                                <br>
                                <input type="file" id="fileUpload" accept=".json" multiple/>
                                <input type="button" id="create-index" value="Create Index" />

                            </div>
                            <!--for search-->
                            <div id="searchDiv">
                                <h3 id="titleOption"> Serch Your JSON file</h3>
                                <br>
                                <div id="search-expand">
                                    <input type="input" id="search-input" placeholder="Search Json..." />
                                    <label> Select by names </label>
                                        <select id="filter-drop" name="type">
                                            <option value = "all">All</option> 
                                        </select>
                                <br>
                                </div>
                            </div>
                        </div>
                        <br>
                        <div class="line"></div>
                            <div id="showIndexId">
                                <label> Show Index </label>
                                <select id="index-drop-list" name="type"> </select>
                            </div>
                        <div class="indexDiv" id="table-holder">
                            <table class="responstable">
                                <thead id="table-head"></thead>
                                <tbody id="table-body"></tbody>
                            </table>
                        </div>
                    </figure>
                </div>
            </article>
        </section>
        <footer>
            <div class="line"></div>
            <p>Copyright 2016 - Andela Simulation - Inverted index</p>
        </footer>
    </section>
    <script type="text/javascript">

//  Tick present word document with jquery
// This function populate the in index table
let checkIndex = (dataIndex,length,fileName) => {
    $('#table-head').append('<tr><th>'+fileName+' file</th>')
    for (let headLoop = 0; headLoop <= length ; headLoop++){
      if(headLoop === 0){
          $('#table-head').append('<th>Terms</th>');
      }
      else {
          $('#table-head').append('<th>doc_'+headLoop+'</th>');
      }
    
    }
    $('#table-head').append('</tr>');
    for(let index in dataIndex){
        $('#table-body').append('<tr>');
        $('#table-body').append('<td>'+index+'</td>');
        for (var k = 0 ; k < length; k++){
                if (dataIndex[index][k]){
                $('#table-body').append('<td>'+'<i class = "fa fa-check"'+
                'style = "font-size:15px"></i>'+'</td>' );
            } else {
                $('#table-body').append('<td>'+'<i class = "fa fa-times-circle-o"'+
                'aria-hidden = "true"></i>'+'</td>');
        } 
    }
    $('#table-body').append('</tr>');
  }
}


// On press enter, it will call search function
$('#search-input').keypress(function(e) {
    if(e.which == 13) {
        deleteTable();
        searchFunction();
    }
});

// json file upload
document.getElementById('fileUpload').addEventListener(''+
  'change',function(e){
   getFile(e.target.files[0]);
});

// create index button click
 $('#create-index').click(function(event){
     let listOfFileName = [];
     if(document.getElementById('fileUpload').value == ""){
         alert("Upload a file");
         return;
     }
     invertedClass.createIndex(invertedClass.json,invertedClass.fileName);
     console.log(invertedClass.length);
     let fileName = invertedClass.fileName;
     listOfFileName.push(fileName);
     console.log(listOfFileName);

// dynamically populate dropdown list with uploaded file name
     $.each(listOfFileName, function() {
        options.append($("<option />").val(this).text(this));
     });

     $.each(listOfFileName, function() {
        indexListOptions.append($("<option />").val(this).text(this));
     });

     deleteTable();
     checkIndex(invertedClass.getIndex(fileName), 
     invertedClass.jLength[fileName],fileName,setInputEmpty());
     invertedClass.json=null;
     invertedClass.fileName=null;

 });

// Set input element of type file to ""
 let setInputEmpty = () => {
     document.getElementById('fileUpload').value = "";
 }

// filter search option
 let options = $("#filter-drop");
 //dropdown list for index viewing
 let indexListOptions = $("#index-drop-list");

$('#index-drop-list').on('change', function() {
   let jsonName = $(this).val() ;
   deleteTable();
   checkIndex(invertedClass.getIndex(jsonName), invertedClass.jLength[jsonName],jsonName);
});

let deleteTable = () => {
  $('.responstable tr').remove();
  $('.responstable th').remove();
  $('.responstable td').remove();
}


let searchFunction = () => {
    let searchValue = $('#search-input').val();
        let filterName = document.getElementById("filter-drop");
        let selectedFilter = filterName.options[filterName.selectedIndex].value;
        console.log(searchValue, selectedFilter);
        let searchResult = invertedClass.searchIndex(searchValue,selectedFilter);
        checkIndex(searchResult,invertedClass.jLength[selectedFilter],selectedFilter);

}

let getFile = (filePath) => {
        let regex = /^([a-zA-Z0-9\s_\\.\-:])+(.json)$/;
        if (regex.test($("#fileUpload").val().toLowerCase())) {
            if (typeof (FileReader) != "undefined") {
                let reader = new FileReader();
                invertedClass.fileName = filePath.name;
                reader.onload = function (e) {
                    let jUpload = JSON.parse(reader.result);
                    if(invertedClass.isValidJson(reader.result)){ 
                        if(!invertedClass.isJsonEmpty(jUpload)){
                           invertedClass.json=jUpload;
                        }
                    } else {
                        alert("Invalid JSON FILE")
                    }                        
                };
                reader.readAsText(filePath);
            } else {
                alert("This browser does not support HTML5.");
            }
        } else {
            alert("Please upload a valid JSON file.");
        }
    }


</script>
</body>

</html>